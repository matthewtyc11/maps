<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Smooth GPS Tracker & Speedometer</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        /* Speedometer Display */
        #speedPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        #speedValue {
            font-size: 28px;
            font-weight: bold;
            color: #2b82cb;
            display: block;
        }

        .speed-unit {
            font-size: 14px;
            color: #555;
        }
        
        /* Bottom Controls */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 18px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        #startBtn { background-color: #2b82cb; } 
        #clearBtn { background-color: #e74c3c; } 
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="speedPanel">
        <span id="speedValue">0.0</span>
        <span class="speed-unit">km/h</span>
    </div>
    
    <div id="controls">
        <button id="startBtn">Start Tracking</button>
        <button id="clearBtn">Clear Track</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);

        let savedPath = JSON.parse(localStorage.getItem('myGpsPath')) || [];
        let pathLine = L.polyline(savedPath, {color: '#2b82cb', weight: 5, opacity: 0.8}).addTo(map);
        let currentMarker = null;
        let watchId = null;

        if (savedPath.length > 0) {
            map.fitBounds(pathLine.getBounds());
            currentMarker = L.marker(savedPath[savedPath.length - 1]).addTo(map);
        }

        const startBtn = document.getElementById('startBtn');
        const speedValueDisplay = document.getElementById('speedValue');

        startBtn.addEventListener('click', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                startBtn.innerText = "Start Tracking";
                startBtn.style.backgroundColor = "#2b82cb"; 
                speedValueDisplay.innerText = "0.0"; // Reset speed display when stopped
            } else {
                if ("geolocation" in navigator) {
                    startBtn.innerText = "Tracking... (Stop)";
                    startBtn.style.backgroundColor = "#f39c12"; 
                    
                    watchId = navigator.geolocation.watchPosition(
                        updatePosition, 
                        handleError, 
                        { enableHighAccuracy: true, maximumAge: 0 }
                    );
                } else {
                    alert("Geolocation is not supported by your browser.");
                }
            }
        });

        const clearBtn = document.getElementById('clearBtn');
        
        clearBtn.addEventListener('click', () => {
            if(confirm("Are you sure you want to erase your saved route?")) {
                savedPath = []; 
                localStorage.removeItem('myGpsPath'); 
                pathLine.setLatLngs(savedPath); 
                
                if (currentMarker) {
                    map.removeLayer(currentMarker); 
                    currentMarker = null;
                }
            }
        });

        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const newPoint = [lat, lng];

            // --- SPEED CALCULATION ---
            // position.coords.speed is in meters per second. 
            // If the phone can't calculate it (e.g., sitting still indoors), it returns null.
            let speedMetersPerSecond = position.coords.speed;
            
            if (speedMetersPerSecond === null || speedMetersPerSecond < 0) {
                speedMetersPerSecond = 0;
            }

            // Convert to kilometers per hour (multiply by 3.6)
            // Note: If you want miles per hour (mph), multiply by 2.23694 instead!
            let speedKmh = speedMetersPerSecond * 3.6;
            
            // Update the HTML display (toFixed(1) keeps just one decimal place, like "15.2")
            speedValueDisplay.innerText = speedKmh.toFixed(1);
            // -------------------------

            savedPath.push(newPoint);
            localStorage.setItem('myGpsPath', JSON.stringify(savedPath));
            pathLine.setLatLngs(savedPath);

            if (currentMarker) {
                currentMarker.setLatLng(newPoint);
            } else {
                currentMarker = L.marker(newPoint).addTo(map);
            }

            map.flyTo(newPoint, 17, { animate: true, duration: 0.5 }); 
        }

        function handleError(error) {
            console.error("Error getting location: ", error.message);
            if(error.code === 1) {
                alert("Please allow location permissions in your browser.");
            }
        }
    </script>
</body>
</html>
